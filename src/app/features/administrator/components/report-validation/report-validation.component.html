<div class="myContentClass container">
    <h2 class="card-subheading center" >Liste globale des rapports</h2><br>
    <p class="card-heading"><small>Ci-dessous vous trouverez la liste de tout les rapports soumis par les étudiants.</small></p><hr>
    

      <!-- FILTERS -------------------------------------------------------------------------------------------------------------------------------------------------------------->
  <div id="header-search-people" class="form-area" novalidate="novalidate" autocomplete="off">
    <div class="row">
        <div class="col-md-10">
            <div class="styled-input multi" style="height: 60px;">
              <div id="select-type" class="type">
                <select name="type" [(ngModel)]="selectedValidatedAdmin" (ngModelChange)="applyFilters()">
                  <option value="V">V</option>
                  <option value="NV">NV</option>
                </select>
                <label>Validé par admin</label>
                <svg class="chevron-down" width="17px" height="10px" viewBox="0 0 17 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink">
                    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g id="UI-Elements-Forms" transform="translate(-840.000000, -753.000000)" stroke="#4A4A4A" stroke-width="0.9">
                            <g id="Done-Copy-2" transform="translate(622.000000, 727.000000)">
                                <polyline id="Rectangle-16" transform="translate(226.400000, 27.400000) rotate(-45.000000) translate(-226.400000, -27.400000) "
                                    points="231.8 32.8 221 32.8 221 22"></polyline>
                            </g>
                        </g>
                    </g>
                </svg>
              </div>
                <div>
                    <input type="text" [(ngModel)]="filterPromotion" data-placeholder-focus="false" (ngModelChange)="applyFilters()">
                    <label>Promotion</label>
                </div>
                <div id="select-type" class="type">
                    <select name="type" [(ngModel)]="selectFiliere" (ngModelChange)="applyFilters()">
                        <!-- <option value="Tout">Tout</option> -->
                        <option value="GI">GI</option>
                        <option value="GM">GM</option>
                        <option value="GE">GE(ancienne)</option>
                        <option value="GEM">GEM</option>
                        <option value="IAGI">IAGI</option>
                        <option value="MSEI">MSEI</option>
                    </select>
                    <label>Filière</label>
                    <svg class="chevron-down" width="17px" height="10px" viewBox="0 0 17 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="UI-Elements-Forms" transform="translate(-840.000000, -753.000000)" stroke="#4A4A4A" stroke-width="0.9">
                                <g id="Done-Copy-2" transform="translate(622.000000, 727.000000)">
                                    <polyline id="Rectangle-16" transform="translate(226.400000, 27.400000) rotate(-45.000000) translate(-226.400000, -27.400000) "
                                        points="231.8 32.8 221 32.8 221 22"></polyline>
                                </g>
                            </g>
                        </g>
                    </svg>
                </div>
                <div id="select-type" class="type">
                    <select name="type" [(ngModel)]="selectedReportType" (ngModelChange)="applyFilters()">
                        <!-- <option value="Tout">Tout</option> -->
                        <option value="Initiation">Initiation</option>
                        <option value="PFA">PFA</option>
                        <option value="PFE">PFE</option>
                    </select>
                    <label>Type rapport</label>
                    <svg class="chevron-down" width="17px" height="10px" viewBox="0 0 17 10" version="1.1" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="UI-Elements-Forms" transform="translate(-840.000000, -753.000000)" stroke="#4A4A4A" stroke-width="0.9">
                                <g id="Done-Copy-2" transform="translate(622.000000, 727.000000)">
                                    <polyline id="Rectangle-16" transform="translate(226.400000, 27.400000) rotate(-45.000000) translate(-226.400000, -27.400000) "
                                        points="231.8 32.8 221 32.8 221 22"></polyline>
                                </g>
                            </g>
                        </g>
                    </svg>
                  </div>
            </div>
        </div>
        <div class="col-md-2 no-pad-left-10">
            <button type="submit" class="primary-btn serach-btn" (click)="renitialiserFiltres()">Renitialiser filtres</button>
        </div>

    </div>
  </div>


    <div class="table-responsive custom-table-responsive" > 

      <div class="send-request">
        <button
          nz-button
          nzType="primary"
          [disabled]="setOfCheckedId.size === 0"

          (click)="sendRequest()"
        >
          Valider Rapports
        </button>
        <span> {{ setOfCheckedId.size }} rapports selectionnées</span>
      </div>

      <nz-table #reportTable [nzFrontPagination]="false" [nzData]="reports" 
      [nzScroll]="{ x: '1500px' }"
      (nzCurrentPageDataChange)="onCurrentPageDataChange($event)"
      class="table custom-table">
          <thead>
            <tr> 
                <th scope="col" nzWidth="25%" [nzChecked]="checked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)"></th>
                <th scope="col" nzWidth="25%">Lien rapp.</th>
                <th scope="col" nzWidth="30%">Stage/Projet</th>
                <th scope="col" nzWidth="25%">Type rapp.</th>
                <th scope="col" nzWidth="50%">Intitulé rapp.</th>
                <th scope="col" nzWidth="40%">Date début</th>
                <th scope="col" nzWidth="40%">Date fin</th>
                <th scope="col" nzWidth="35%">Société Stage</th>
                <th scope="col" nzWidth="35%">Secteur Société</th>
                <th scope="col" nzWidth="30%">Pays Soc.</th>
                <th scope="col" nzWidth="30%">Ville Soc.</th>
                <!-- <th scope="col" nzWidth="30%">Parrain industriel.</th>
                <th scope="col" nzWidth="30%">Email parrain.</th>
                <th scope="col" nzWidth="30%">Tel parrain</th> -->
                <th scope="col" nzWidth="30%">Confidentiel</th>
                <th scope="col" nzWidth="35%">Etudiant</th>
                <th scope="col" nzWidth="25%">Valid</th>
                <th scope="col" nzRight nzWidth="30%">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let report of reportTable.data 
            | reportTypeFilter : selectedReportType 
            | promotionFilter : filterPromotion 
            | filiereFilter : selectFiliere
            | adminValidated : selectedValidatedAdmin
            | paginate : { itemsPerPage: 10, currentPage: p } ; let i = index" [class.active]="i == currentIndex" (click)="setActiveReport(report, i)">
                

            <ng-container *ngIf="!edit[report.id].edit; else editReport">
              <td
              [nzChecked]="setOfCheckedId.has(report.id) || report.valid_admin"
              [nzDisabled]="report.valid_admin"
              (nzCheckedChange)="onItemChecked(report.id, $event)"
            ></td>  
                <td class="classLink"><a target="_blank" href="http://localhost:8080{{ report.fichier_rapport.toString() }}"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                    </svg>
                </a></td>
                <td>{{report.stage_ou_projet ? "Stage" : "Projet" }}</td>
                <td>{{report.type_rapport}}</td>
                <td routerLink="/rapport/info/{{ report.id }}" class="classLink"><A>{{capitalizeFirstLetter(report.intitule_stage)}}</A></td>
                <td>{{report.date_debut_stage | date: 'dd/MM/yyyy'}}</td>
                <td>{{report.date_fin_stage | date: 'dd/MM/yyyy'}}</td>
                <td>{{report.societe_stage}}</td>
                <td>{{report.secteur_societe}}</td>
                <td>{{report.pays_societe}}</td>
                <td>{{report.ville_societe}}</td>
                <!-- <td>{{report.encadrant}}</td>
                <td>{{report.email_encadrant}}</td>
                <td>{{report.telephone_encadrant}}</td> -->
                <td>{{report.rapport_confidentiel ? "oui" : "non"}}</td>
                <td routerLink="/profile-etudiant/{{report.fk_etudiant.id}}"  class="classLink"><a>{{report.fk_etudiant.nom_prenom}}</a></td>
                <td>{{report.valid_admin ? "V" : "NV"}}</td>
                <td nzRight >
                  <div>
                    <a (click)="startEditReport(report.id)">
                      Modifier
                    </a>
                  </div>
                  <div>
                    <a (click)="deleteReport(report.id)">
                      Supprimer
                    </a>
                  </div> 
                </td>
              </ng-container> 
            
            <ng-template #editReport >

              <td
              [nzChecked]="setOfCheckedId.has(report.id)"
              [nzDisabled]="report.valid_admin"
              (nzCheckedChange)="onItemChecked(report.id, $event)"
            ></td> 

                <td class="classLink"><a target="_blank" href="http://localhost:8080{{ report.fichier_rapport.toString() }}"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                    </svg>
                </a></td>

                <td>
                    <select nz-input [(ngModel)]="report.stage_ou_projet" required #stage_ou_projet="ngModel" name="stage_ou_projet">
                        <option *ngFor="let nature of natures" [ngValue]="nature.nature" selected>
                            {{ nature.name }}
                           </option>
                    </select>
                </td>

                <td>
                    <select nz-input [(ngModel)]="report.type_rapport" required #type_rapport="ngModel" name="type_rapport">
                      <option *ngFor="let type of types_rapport" [ngValue]="type">
                        {{ type }}
                      </option>
                    </select>
                </td>

                <td>
                  <input type="text" nz-input [(ngModel)]="report.intitule_stage" required #intitule_stage="ngModel" name="intitule_stage" maxlength="200"/>
                  <div *ngIf="intitule_stage.errors && (intitule_stage.dirty || intitule_stage.touched)">
                    <div [hidden]="!intitule_stage.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis et il ne peut pas comporter plus de 200 caractères."></div>
                  </div>
                </td>

                <td>
                    <input type="date" nz-input name="dateDebut" required #dateDebut="ngModel"
                            pattern="(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))"
                        [(ngModel)]="report.date_debut_stage">
                    <div *ngIf="dateDebut.errors && (dateDebut.dirty || dateDebut.touched)">
                    <div [hidden]="!dateDebut.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis."></div>
                    </div>
                </td> 
                
                <td>
                    <input type="date" nz-input name="dateFin" required #dateFin="ngModel"
                            pattern="(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))"
                        [(ngModel)]="report.date_fin_stage">
                    <div *ngIf="dateFin.errors && (dateFin.dirty || dateFin.touched)">
                    <div [hidden]="!dateFin.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis."></div>
                    </div>
                </td>    

                <td>
                    <input type="text" nz-input [(ngModel)]="report.societe_stage" required #societe_stage="ngModel" name="societe_stage" maxlength="200"/>
                    <div *ngIf="societe_stage.errors && (societe_stage.dirty || societe_stage.touched)">
                      <div [hidden]="!societe_stage.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis et il ne peut pas comporter plus de 200 caractères."></div>
                    </div>
                </td>
                
                <td>
                    <input type="text" nz-input [(ngModel)]="report.secteur_societe" required #secteur_societe="ngModel" name="secteur_societe" maxlength="200"/>
                    <div *ngIf="secteur_societe.errors && (secteur_societe.dirty || secteur_societe.touched)">
                      <div [hidden]="!secteur_societe.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis et il ne peut pas comporter plus de 200 caractères."></div>
                    </div>
                </td>
                
                <td>
                    <input type="text" nz-input [(ngModel)]="report.pays_societe" required #pays_societe="ngModel" name="pays_societe" maxlength="200"/>
                    <div *ngIf="pays_societe.errors && (pays_societe.dirty || pays_societe.touched)">
                      <div [hidden]="!pays_societe.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis et il ne peut pas comporter plus de 200 caractères."></div>
                    </div>
                </td>

                <td>
                    <input type="text" nz-input [(ngModel)]="report.ville_societe" required #ville_societe="ngModel" name="ville_societe" maxlength="200"/>
                    <div *ngIf="ville_societe.errors && (ville_societe.dirty || ville_societe.touched)">
                      <div [hidden]="!ville_societe.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Ce champ est requis et il ne peut pas comporter plus de 200 caractères."></div>
                    </div>
                </td>

                <!-- <td>{{report.encadrant}}</td>

                <td>
                    <input type="text" nz-input [(ngModel)]="report.email_encadrant" pattern="^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{1,5}|[0-9]{1,3})(\]?)$" #email_encadrant="ngModel" name="email_encadrant"/>
                    <div *ngIf="email_encadrant.errors && (email_encadrant.dirty || email_encadrant.touched)" >
                      <div [hidden]="!email_encadrant.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Veuillez entrer un email valide !"></div>
                    </div>
                </td>

                <td>
                    <input type="text" nz-input [(ngModel)]="report.telephone_encadrant"  pattern="^\+[1-9]{1}[0-9]{3,14}$" required #tel="ngModel" name="tel"/>
                    <div *ngIf="tel.errors && (tel.dirty || tel.touched)">
                      <div [hidden]="!tel.errors" [(nzPopoverVisible)]=!hidden nz-popover nzPopoverContent="Veuillez entrer un numéro de téléphone valide (Format: +...) !"></div>
                    </div>
                </td> -->
                

                <td>
                    <input nz-input type="checkbox" name="rapport_confidentiel" 
                    [(ngModel)]="report.rapport_confidentiel">
                </td>

                <td>{{report.fk_etudiant.nom_prenom}}</td>

                
                <!-- <td>
                    <input nz-input type="checkbox" name="valid_admin" 
                    [(ngModel)]="report.valid_admin">
                </td> -->

                <td>{{report.valid_admin ? "V" : "NV"}}</td>



                <td nzRight >
                  <div>
                    <a (click)="saveEditReport(report.id)" style="margin-right: 8px;">
                      Modifier
                    </a>
                    <a (click)="cancelEditReport()">
                      Annuler
                    </a>
                  </div>
                  <div>
                    <a (click)="deleteReport(report.id)">
                      Supprimer
                    </a>
                  </div> 
                </td>
              </ng-template>
            </tr>            
          </tbody>
      </nz-table>
    </div>
    <div  class="center">
      <pagination-controls (pageChange)="p = $event"></pagination-controls>
    </div>
  </div>
  